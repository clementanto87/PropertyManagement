generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-arm64-openssl-1.1.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(MANAGER)
  tenantId  String?  @unique
  otpCode   String?
  otpExpiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant?         @relation(fields: [tenantId], references: [id])
  auditLogs      AuditLog[]
  communications Communication[]
  posts          Post[]
  amenityBookings AmenityBooking[]
  notifications   Notification[]
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  action    String
  entity    String
  entityId  String
  createdAt DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id])
}

enum Role {
  ADMIN
  MANAGER
  TENANT
}

model Property {
  id            String     @id @default(cuid())
  name          String
  address       String
  type          String     @default("apartment")
  price         Int        @default(0)
  bedrooms      Int        @default(0)
  bathrooms     Float      @default(0)
  area          Int        @default(0)
  status        String     @default("vacant")
  description   String?
  features      String[]
  yearBuilt     Int?
  parkingSpaces Int?
  image         String?
  latitude      Float?
  longitude     Float?
  units         Unit[]
  documents     Document[]
  expenses      Expense[]
  posts         Post[]
  amenities     Amenity[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

model Unit {
  id          String               @id @default(cuid())
  propertyId  String
  unitNumber  String
  bedrooms    Int
  bathrooms   Int
  sizeSqft    Int?
  status      UnitStatus           @default(VACANT)
  leases      Lease[]
  workOrders  WorkOrder[]
  media       Media[]
  documents   Document[]
  maintenance MaintenanceHistory[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  property Property @relation(fields: [propertyId], references: [id])

  @@unique([propertyId, unitNumber])
}

enum UnitStatus {
  OCCUPIED
  VACANT
  MAINTENANCE
}

model Tenant {
  id               String             @id @default(cuid())
  name             String
  email            String?            @unique
  phone            String?
  emergencyContact String?
  leases           Lease[]
  communications   Communication[]
  invitations      TenantInvitation[]
  user             User?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  notifications    Notification[]
}

model Lease {
  id              String           @id @default(cuid())
  unitId          String
  tenantId        String
  startDate       DateTime
  endDate         DateTime
  securityDeposit Int?
  rentAmount      Int
  status          LeaseStatus      @default(ACTIVE)
  payments        Payment[]
  documents       Document[]
  agreements      LeaseAgreement[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  unit   Unit   @relation(fields: [unitId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])
}

enum LeaseStatus {
  ACTIVE
  TERMINATED
  EXPIRED
  PENDING
}

model Payment {
  id                     String         @id @default(cuid())
  leaseId                String
  amount                 Int
  dueDate                DateTime
  paidAt                 DateTime?
  status                 PaymentStatus  @default(PENDING)
  paymentMethod          PaymentMethod?
  notes                  String?
  receiptNumber          String?        @unique
  stripePaymentIntentId  String?        @unique
  stripeReceiptUrl       String?
  createdAt              DateTime       @default(now())

  lease Lease @relation(fields: [leaseId], references: [id])
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
}

enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CREDIT_CARD
  OTHER
}

model Expense {
  id         String   @id @default(cuid())
  propertyId String
  amount     Int
  category   String
  note       String?
  receiptUrl String?
  incurredAt DateTime
  createdAt  DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id])
}

model WorkOrder {
  id          String          @id @default(cuid())
  unitId      String
  vendorId    String?
  title       String
  description String?
  status      WorkOrderStatus @default(NEW)
  photos      Media[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  unit   Unit    @relation(fields: [unitId], references: [id])
  vendor Vendor? @relation(fields: [vendorId], references: [id])
}

enum WorkOrderStatus {
  NEW
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

model Vendor {
  id         String      @id @default(cuid())
  name       String
  contact    String?
  rateInfo   String?
  insured    Boolean     @default(false)
  workOrders WorkOrder[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model Document {
  id         String   @id @default(cuid())
  leaseId    String?
  propertyId String?
  unitId     String?
  title      String
  url        String
  type       String?
  createdAt  DateTime @default(now())

  lease    Lease?    @relation(fields: [leaseId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])
  unit     Unit?     @relation(fields: [unitId], references: [id])
}

model Media {
  id          String   @id @default(cuid())
  unitId      String?
  workOrderId String?
  url         String
  type        String?
  createdAt   DateTime @default(now())

  unit      Unit?      @relation(fields: [unitId], references: [id])
  workOrder WorkOrder? @relation(fields: [workOrderId], references: [id])
}

model Communication {
  id               String    @id @default(cuid())
  tenantId         String
  userId           String?
  type             String // email/call/meeting/note
  channel          String
  summary          String
  content          String
  followUpRequired Boolean   @default(false)
  followUpDate     DateTime?
  direction        CommunicationDirection @default(OUTBOUND)
  isRead           Boolean                @default(false)
  readAt           DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

enum TemplateType {
  EMAIL
  AGREEMENT
  INVOICE
}

model Template {
  id          String       @id @default(cuid())
  type        TemplateType
  name        String
  subject     String?
  body        String       @db.Text
  category    String       // 'rent_reminder', 'maintenance', 'welcome', 'lease_renewal', 'move_out', 'invoice', 'agreement'
  variables   Json         // Available variables like {{tenantName}}, {{rentAmount}}
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model MaintenanceHistory {
  id          String   @id @default(cuid())
  unitId      String
  note        String?
  cost        Int?
  performedAt DateTime
  createdAt   DateTime @default(now())

  unit Unit @relation(fields: [unitId], references: [id])
}

model LeaseAgreement {
  id              String           @id @default(cuid())
  leaseId         String           @unique
  templateContent String           @db.Text
  status          AgreementStatus  @default(PENDING)
  sentAt          DateTime?
  signedAt        DateTime?
  expiresAt       DateTime?
  signatures      LeaseSignature[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  lease Lease @relation(fields: [leaseId], references: [id])
}

enum AgreementStatus {
  DRAFT
  PENDING
  SIGNED
  EXPIRED
  VOIDED
}

model LeaseSignature {
  id              String          @id @default(cuid())
  agreementId     String
  signerType      SignerType
  signerName      String
  signerEmail     String
  signatureData   String?         @db.Text
  signatureMethod SignatureMethod @default(TYPED)
  ipAddress       String?
  signedAt        DateTime?
  createdAt       DateTime        @default(now())

  agreement LeaseAgreement @relation(fields: [agreementId], references: [id])
}

enum SignerType {
  LANDLORD
  TENANT
}

enum SignatureMethod {
  TYPED
  DRAWN
}

model TenantInvitation {
  id         String    @id @default(cuid())
  tenantId   String
  email      String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  category  String   // ANNOUNCEMENT, EVENT, MARKETPLACE
  authorId  String
  propertyId String? // Optional: specific to a property
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author   User      @relation(fields: [authorId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])
}

model Amenity {
  id          String   @id @default(cuid())
  name        String
  description String?
  propertyId  String
  maxCapacity Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property Property         @relation(fields: [propertyId], references: [id])
  bookings AmenityBooking[]
}

model AmenityBooking {
  id        String   @id @default(cuid())
  amenityId String
  userId    String
  startTime DateTime
  endTime   DateTime
  status    String   @default("PENDING") // PENDING, CONFIRMED, CANCELLED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  amenity Amenity @relation(fields: [amenityId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String?  // For Property Managers
  tenantId  String?  // For Tenants
  title     String
  message   String
  type      String   // 'MESSAGE', 'ALERT', etc.
  metadata  Json?    // For storing extra data like count, senderId, etc.
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user   User?   @relation(fields: [userId], references: [id])
  tenant Tenant? @relation(fields: [tenantId], references: [id])
}
